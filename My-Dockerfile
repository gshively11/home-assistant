FROM resin/raspberrypi3-python:3.6
MAINTAINER Grant Shively <gshively11@gmail.com>

# Install Home Assistant

# Uncomment any of the following lines to disable the installation.
ENV INSTALL_TELLSTICK no
#ENV INSTALL_OPENALPR no
#ENV INSTALL_FFMPEG no
#ENV INSTALL_OPENZWAVE no
ENV INSTALL_LIBCEC no
ENV INSTALL_PHANTOMJS no

VOLUME /config

RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

# Copy build scripts
COPY virtualization/Docker/ virtualization/Docker/
RUN virtualization/Docker/setup_docker_prereqs

# Install hass component dependencies
COPY requirements_all.txt requirements_all.txt
RUN pip3 install --no-cache-dir -r requirements_all.txt && \
    pip3 install --no-cache-dir mysqlclient psycopg2 uvloop

# Copy source
COPY . .

# Putting custom stuff after home-assistant build because it takes forever

# Install nginx

RUN apt-get update \
  && apt-get install -y -q --no-install-recommends \
    ca-certificates \
    nginx \
    wget \
  && apt-get clean \
  && rm -r /var/lib/apt/lists/*
RUN ln -sf /dev/stdout /var/log/nginx/access.log \
  && ln -sf /dev/stderr /var/log/nginx/error.log
COPY my-config/nginx-home-assistant /etc/nginx/sites-available/home-assistant
RUN ln -s /etc/nginx/sites-available/home-assistant /etc/nginx/sites-enabled/home-assistant

# Install letsencrypt

RUN echo "deb http://httpredir.debian.org/debian jessie-backports main contrib non-free" \
  > /etc/apt/sources.list.d/debian-jessie-backports.list \
  && apt-get update -y \
  && apt install letsencrypt -t jessie-backports -y \
  && rm /etc/apt/sources.list.d/debian-jessie-backports.list \
  && apt-get update -y \
  && apt-get clean \
  && rm -r /var/lib/apt/lists/*
# Setup a weeklky cron to attempt renewal of ssl certs (only renews if expiring within 30 days)
COPY my-scripts/letsencrypt-renew.sh /etc/cron.weekly/letsencrypt

# Install Fail2Ban

RUN apt-get update \
  && apt-get install -y -q --no-install-recommends \
    fail2ban \
  && apt-get clean \
  && rm -r /var/lib/apt/lists/*
COPY my-config/jail.conf /etc/fail2ban/jail.conf

ENTRYPOINT /usr/src/app/my-docker-entrypoint.sh

EXPOSE 80 443
